<?xml version="1.0" encoding="UTF-8"?>

<!--
   Copyright (c) 2001-2007, Inversoft, All Rights Reserved

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing,
   software distributed under the License is distributed on an
   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
   either express or implied. See the License for the specific
   language governing permissions and limitations under the License.
-->
<project name="svn-macros">
  <dirname property="dir.plugin.svn-macros" file="${ant.file.svn-macros}"/>
  <path id="classpath.svn-macros">
    <fileset dir="${dir.plugin.svn-macros}/lib" includes="*.jar"/>
  </path>

  <!-- load the svn task -->
  <typedef resource="org/tigris/subversion/svnant/svnantlib.xml" classpathref="classpath.svn-macros"/>

  <!-- Target for tagging head -->
  <macrodef name="scm_tag_head">
    <attribute name="tag"/>
    <attribute name="username"/>
    <attribute name="password"/>
    <attribute name="url"/>
    <sequential>
    <if>
      <equals arg1="${debug}" arg2="false"/>
      <then>
        <scm_copy src="@{url}/trunk" dest="@{url}/tags/@{tag}" operation="Tagging head" username="@{username}" password="@{password}"/>
      </then>
    </if>
    </sequential>
  </macrodef>

  <!-- Target for tagging head -->
  <macrodef name="scm_tag_branch">
    <attribute name="branch"/>
    <attribute name="tag"/>
    <attribute name="username"/>
    <attribute name="password"/>
    <attribute name="url"/>
    <sequential>
    <if>
      <equals arg1="${debug}" arg2="false"/>
      <then>
        <scm_copy src="@{url}/branches/@{branch}" dest="@{url}/tags/@{tag}" operation="Tagging branch" username="@{username}" password="@{password}"/>
      </then>
    </if>
    </sequential>
  </macrodef>

  <!-- Target for branching head -->
  <macrodef name="scm_branch_head">
    <attribute name="branch"/>
    <attribute name="username"/>
    <attribute name="password"/>
    <attribute name="url"/>
    <sequential>
    <if>
      <equals arg1="${debug}" arg2="false"/>
      <then>
        <scm_copy src="@{url}/trunk" dest="@{url}/branches/@{branch}" operation="Branching head" username="@{username}" password="@{password}"/>
      </then>
    </if>
    </sequential>
  </macrodef>

  <!-- Target for branching a tag -->
  <macrodef name="scm_branch_tag">
    <attribute name="tag"/>
    <attribute name="branch"/>
    <attribute name="username"/>
    <attribute name="password"/>
    <attribute name="url"/>
    <sequential>
    <if>
      <equals arg1="${debug}" arg2="false"/>
      <then>
        <scm_copy src="@{url}/tags/@{tag}" dest="@{url}/branches/@{branch}" operation="Branching tag" username="@{username}" password="@{password}"/>
      </then>
    </if>
    </sequential>
  </macrodef>

  <macrodef name="scm_check_out_head">
    <attribute name="dir"/>
    <attribute name="username"/>
    <attribute name="password"/>
    <attribute name="url"/>

    <sequential>
      <scm_checkout url="@{url}/trunk" dir="@{dir}" username="@{username}" password="@{password}"/>
    </sequential>
  </macrodef>

  <!-- Checks out a branch -->
  <macrodef name="scm_check_out_branch">
    <attribute name="dir"/>
    <attribute name="branch"/>
    <attribute name="username"/>
    <attribute name="password"/>
    <attribute name="url"/>

    <sequential>
      <scm_checkout url="@{url}/branches/@{branch}" dir="@{dir}" username="@{username}" password="@{password}"/>
    </sequential>
  </macrodef>

  <!-- Checks out a branch -->
  <macrodef name="scm_check_out_tag">
    <attribute name="dir"/>
    <attribute name="tag"/>
    <attribute name="username"/>
    <attribute name="password"/>
    <attribute name="url"/>

    <sequential>
      <scm_checkout url="@{url}/tags/@{tag}" dir="@{dir}" username="@{username}" password="@{password}"/>
    </sequential>
  </macrodef>

  <!-- checks that a version tag doesn't already exist -->
  <macrodef name="scm_check_tag_available">
    <attribute name="tag"/>
    <attribute name="username"/>
    <attribute name="password"/>
    <attribute name="url"/>

    <sequential>
      <property name="tag.url" value="@{url}/tags/@{tag}"/>
      <echo message="Checking that tag ${tag.url} doesn't already exist for ${project.name}"/>
      <condition property="version.exists" value="true">
        <betterhttp url="${tag.url}" username="@{username}" password="@{password}"/>
      </condition>

      <if>
        <equals arg1="${version.exists}" arg2="true"/>
        <then>
          <fail message="Tag [@{tag}] already exists."/>
        </then>
      </if>
    </sequential>
  </macrodef>

  <!-- checks that a tag is valid -->
  <macrodef name="scm_tag_validation">
    <attribute name="tag"/>
    <attribute name="username"/>
    <attribute name="password"/>
    <attribute name="url"/>

    <sequential>
      <property name="tag.url" value="@{url}/tags/@{tag}"/>

      <echo message="Checking that tag ${tag.url} is valid"/>

      <condition property="version.exists" value="true">
        <betterhttp url="${tag.url}" username="@{username}" password="@{password}"/>
      </condition>

      <if>
        <equals arg1="${version.exists}" arg2="false"/>
        <then>
          <fail message="${tag.url} is not a valid tag."/>
        </then>
      </if>
    </sequential>
  </macrodef>

  <macrodef name="scm_import" description="Imports the current directory into SubVersion">
    <attribute name="project" description="The name of the project as it will exist in SubVersion"/>
    <attribute name="dir" description="The location on disk where the import image exists"/>
    <attribute name="url" description="The subversion url"/>
    <attribute name="username" description="The subversion username"/>
    <attribute name="password" description="The subversion password"/>
    <sequential>
      <condition property="import.project.exists" value="true">
        <betterhttp url="@{url}/@{project}" username="@{username}" password="@{password}"/>
      </condition>

      <if>
        <equals arg1="${import.project.exists}" arg2="true"/>
        <then>
          <fail message="Project name [@{project}] is already taken"/>
        </then>
      </if>

      <svn username="@{username}" password="@{password}">
        <import path="@{dir}" url="@{url}/@{project}" message="[JCATAPULT-ANT Import] project import of @{project}"/>
      </svn>
    </sequential>
  </macrodef>

  <macrodef name="scm_checkout" description="Checks out from source control.">
    <attribute name="url" description="The URL to check out."/>
    <attribute name="dir" description="The directory to check out to."/>
    <attribute name="username" description="The subversion repos username"/>
    <attribute name="password" description="The subversion repos password"/>
    <sequential>
      <mkdir dir="@{dir}"/>

      <echo message="Checking out @{url} to @{dir}"/>

      <svn username="@{username}" password="@{password}">
        <checkout url="@{url}" destPath="@{dir}"/>
      </svn>
    </sequential>
  </macrodef>

  <macrodef name="scm_copy" description="Creates a tag in source control.">
    <attribute name="src" description="The source URL to copy from."/>
    <attribute name="dest" description="The destintation URL to copy into."/>
    <attribute name="operation" description="The operation being performed (tagging or branching)."/>
    <attribute name="username" description="The subversion username"/>
    <attribute name="password" description="The subversion password"/>

    <sequential>
      <echo message="@{operation} @{src} to @{dest}"/>

      <svn username="@{username}" password="@{password}">
        <copy srcUrl="@{src}" destUrl="@{dest}" message="[JCATAPULT-ANT @{operation}] @{src} to @{dest}"/>
      </svn>
    </sequential>
  </macrodef>
</project>
