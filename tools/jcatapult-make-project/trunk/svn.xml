<?xml version="1.0" encoding="UTF-8"?>

<!--
   Copyright (c) 2001-2007, Inversoft, All Rights Reserved

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing,
   software distributed under the License is distributed on an
   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
   either express or implied. See the License for the specific
   language governing permissions and limitations under the License.
-->
<project name="svn">
  <!-- Set the svnant classpath -->
  <dirname property="dir.plugin.svn" file="${ant.file.svn}"/>

  <!-- import macros -->
  <import file="${dir.plugin.svn}/svn-macros.xml"/>

  <target name="-scm-init">

    <!-- set debug to true or false for initialization -->
    <if>
      <isset property="debug"/>
      <then>
        <if>
          <equals arg1="${debug}" arg2="true"/>
          <then>
            <echo>Debug mode set to true</echo>
          </then>
          <else>
            <echo>Debug mode set to false</echo>
          </else>
        </if>
      </then>
      <else>
        <property name="debug" value="false"/>
      </else>
    </if>

    <!-- Assume we are at the root of the project and ensure that build.xml is here -->
    <groovy>
      def f = new File("build.xml");
      if (!f.exists()) {
        properties["fail"] = true;
      }
    </groovy>

    <fail message="You can only run a release from the root of the project being released" if="fail"/>

    <!-- Next parse out the SVN file and grab the URL -->
    <svn username="${svn.username}" password="${svn.password}">
      <info target="." propprefix="svn.info."/>
    </svn>

    <!-- Verify that this is either trunk of branch and set the correct flag -->
    <groovy>
      String url = properties["svn.info.url"];

      String location = "";

      boolean valid = false;
      if (url.indexOf("branches") > -1) {
        valid = true;
        location = "branches";
      } else if (url.indexOf("trunk") > -1) {
        valid = true;
        location = "trunk";
      }

      if (valid) {
        properties["scm.location"] = location;
        properties["svn.repo.url"] = url.substring(0, url.indexOf(location) - 1);
      } else {
        properties["fail"] = true;
      }
    </groovy>

    <fail message="You must be in a working directory that is checkout of from trunk or a branch"
        if="fail"/>
  </target>

  <target name="foo" depends="-scm-init"/>
</project>
